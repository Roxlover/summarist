import puppeteer from "puppeteer";

export async function scrapeTrendyolReviewsWithPuppeteer(productUrl: string) {
  const browser = await puppeteer.launch({ headless: true }); // veya headless: false ile debug
  const page = await browser.newPage();
  await page.goto(productUrl, { waitUntil: "networkidle2", timeout: 60000 });

  // Yorumlar sekmesine tıklamak gerekebilir (Trend ol sayfasında otomatik açılmazsa)
  // await page.click('[data-testid="productReviewsTab"]'); // Gerekirse aç

  // Tüm yorumları yükle (ör: 2 defa "Daha fazla göster" tıklayalım)
  for (let i = 0; i < 2; i++) {
    try {
      await page.waitForSelector(".review-feed__show-more", { timeout: 3000 });
      await page.click(".review-feed__show-more");
      await new Promise(resolve => setTimeout(resolve, 1500));
    } catch {
      break; // Buton yoksa döngüyü bitir
    }
  }

  // Yorumları DOM’dan çek
  const reviews = await page.evaluate(() => {
    // Her yorum kartını seç
    return Array.from(document.querySelectorAll(".review-card"))
      .map(card => {
        const username = card.querySelector(".user-name")?.textContent?.trim() || "";
        const rating = Number(card.querySelector(".star")?.getAttribute("data-rating")) || null;
        const content = card.querySelector(".review-text")?.textContent?.trim() || "";
        const date = card.querySelector(".review-date")?.textContent?.trim() || "";

        return { username, rating, content, date };
      });
  });

  await browser.close();
  return reviews;
}
